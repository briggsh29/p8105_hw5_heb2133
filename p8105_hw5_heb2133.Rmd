---
title: "Homework 5"
output: github_document
---

```{r}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6, 
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis", 
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

Read in data

```{r}
homicide_df = 
  read.csv("./data/homicide-data.csv") %>% 
  janitor::clean_names()
```

This dataset is from the Washington Post, which mapped over 52,000 homicides and any resulting arrests within 50 of the largest cities in America. Key variables in this dataset include Report date; Victim name, age, and sex; City; State; Latitude and longitude; and the Disposition. There are `r nrow(homicide_df)` rows and `r ncol(homicide_df)` columns in this raw dataset. 

Add variables "city_state", "resolved", and summarize total homicides and total unresolved homicides within cities. 

```{r}
homicide_df =
  homicide_df %>% 
  unite("city_state", city:state, sep = "_", remove = TRUE) %>% 
  mutate(
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved")
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")

aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarise(
    total_hom = n(),
    unsolved_hom = sum(resolved == "unsolved")
  )
```

For Baltimore_MD, estimate proportion of homicides that are unsolved. 

```{r}
balt_prop = 
  prop.test(
    aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(unsolved_hom), 
    aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(total_hom)) %>% 
  broom::tidy()

balt_prop %>% pull(estimate)
balt_prop %>% pull(conf.low) 
balt_prop %>% pull(conf.high)
```

Run prop.test for each city, extract the proportion and CIs for each:

```{r}
results_df = 
  aggregate_df %>%
  mutate(
    prop_tests = map2(.x = unsolved_hom, .y = total_hom, ~prop.test(x = .x, n = .y)), 
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)

results_df
```

Create plot for estimates and CIs:

```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2

```{r}

```

